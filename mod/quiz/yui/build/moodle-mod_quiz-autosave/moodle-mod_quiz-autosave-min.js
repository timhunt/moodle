YUI.add("moodle-mod_quiz-autosave",function(e,t){M.mod_quiz=M.mod_quiz||{},M.mod_quiz.autosave={TINYMCE_DETECTION_DELAY:100,TINYMCE_DETECTION_REPEATS:20,WATCH_HIDDEN_DELAY:1e3,delay:12e4,form:null,dirty:!1,delay_timeout_handle:null,save_transaction:null,editor_change_hander:null,hidden_field_values:{},init:function(t){this.form=e.one("#responseform");if(!this.form)return;this.delay=t*1e3,this.form.delegate("valuechange",this.value_changed,"input, textarea",this),this.form.delegate("change",this.value_changed,"select",this),this.init_tinymce(this.TINYMCE_DETECTION_REPEATS),this.save_hidden_field_values(),this.watch_hidden_fields()},save_hidden_field_values:function(){this.form.all("input[type=hidden]").each(function(e){var t=e.get("name");if(!t)return;this.hidden_field_values[t]=e.get("value")},this)},watch_hidden_fields:function(){this.detect_hidden_field_changes(),setTimeout(e.bind(this.watch_hidden_fields,this),this.WATCH_HIDDEN_DELAY)},detect_hidden_field_changes:function(){this.form.all("input[type=hidden]").each(function(e){var t=e.get("name"),n=e.get("value");if(!t)return;n!==this.hidden_field_values[t]&&(this.hidden_field_values[t]=n,this.value_changed({target:e}))},this)},init_tinymce:function(t){if(typeof tinymce=="undefined"){if(t>0){var n=this;setTimeout(function(){n.init_tinymce(t-1)},this.TINYMCE_DETECTION_DELAY)}return}this.editor_change_hander=e.bind(this.editor_changed,this),tinyMCE.onAddEditor.add(e.bind(this.init_tinymce_editor,this))},init_tinymce_editor:function(e,t){t.onChange.add(this.editor_change_hander),t.onRedo.add(this.editor_change_hander),t.onUndo.add(this.editor_change_hander),t.onKeyDown.add(this.editor_change_hander)},value_changed:function(e){this.start_save_timer_if_necessary()},editor_changed:function(e){this.start_save_timer_if_necessary()},start_save_timer_if_necessary:function(){this.dirty=!0;if(this.delay_timeout_handle||this.save_transaction)return;this.start_save_timer()},start_save_timer:function(){this.cancel_delay(),this.delay_timeout_handle=setTimeout(e.bind(this.save_changes,this),this.delay)},cancel_delay:function(){this.delay_timeout_handle&&clearTimeout(this.delay_timeout_handle),this.delay_timeout_handle=null},save_changes:function(){this.cancel_delay(),this.dirty=!1;if(this.is_time_nearly_over()){this.delay_timeout_handle=!0;return}this.save_transaction=e.io(M.cfg.wwwroot+"/mod/quiz/autosave.php",{method:"POST",form:{id:this.form},on:{complete:this.save_done},context:this})},save_done:function(){this.save_transaction=null,this.dirty&&this.start_save_timer()},is_time_nearly_over:function(){return M.mod_quiz.timer&&(new Date).getTime()+2*this.delay>M.mod_quiz.timer.endtime}}},"@VERSION@",{requires:["base","node","event","event-valuechange","node-event-delegate","io-form"]});
